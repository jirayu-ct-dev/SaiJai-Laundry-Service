// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  // เปิดใช้ relationJoins เพื่อประสิทธิภาพที่ดีขึ้นในการ query
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------
// 1. ENUMS (สถานะต่างๆ)
// ------------------------------------------

enum Role {
  User // ลูกค้าทั่วไป (ใช้ User ตาม Better Auth default)
  EMPLOYEE // พนักงานร้าน
  ADMIN // เจ้าของร้าน/ผู้ดูแล
}

enum OrderType {
  PACKAGE // ออเดอร์แบบรายเดือน (หักเครดิต)
  STOREFRONT // ออเดอร์แบบหน้าร้าน (คิดเงินตามชิ้น)
}

enum OrderStatus {
  PENDING_CHECK // รอตรวจสอบผ้า/ยืนยัน
  WASHING // กำลังซัก
  DRYING // กำลังตาก/อบ
  IRONING // กำลังรีด
  READY_FOR_PICKUP // แพ็คพร้อมส่ง/รอรับ
  COMPLETED // ลูกค้ารับผ้าแล้ว (จบงาน)
  CANCELLED // ยกเลิก
}

enum PackageStatus {
  PENDING // รออนุมัติ (เพิ่งสมัคร/ส่งสลิป)
  ACTIVE // ใช้งานได้
  EXPIRED // หมดอายุ/เครดิตหมด
}

enum PaymentStatus {
  PENDING // รอตรวจสอบสลิป
  VERIFIED // ตรวจสอบแล้ว (ผ่าน)
  FAILED // สลิปไม่ผ่าน/ปฏิเสธ
}

// ------------------------------------------
// 2. AUTHENTICATION & USER (Better Auth)
// ------------------------------------------

model User {
  id            String    @id @default(cuid()) // Better Auth ใช้ String ID
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          Role      @default(User)
  
  // เพิ่มเติมสำหรับ Business Logic
  phoneNumber   String?
  lineUserId    String?   @unique // สำหรับส่ง Push Notification
  points        Int       @default(0) // แต้มสะสม

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  sessions              Session[]
  accounts              Account[]
  userPackages          UserPackage[]
  paymentTransactions   PaymentTransaction[] // ประวัติการโอนเงิน
  customerOrders        Order[]              @relation("CustomerOrders")
  employeeOrders        Order[]              @relation("EmployeeOrders")
  customerStatusHistory OrderStatusHistory[] @relation("CustomerStatusHistory")
  employeeHistory       OrderStatusHistory[] @relation("EmployeeHistory")
  userAddresses         UserAddress[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ------------------------------------------
// 3. PACKAGE & SUBSCRIPTION (ระบบสมาชิก)
// ------------------------------------------

model Package {
  id               Int     @id @default(autoincrement())
  name             String
  price            Decimal @db.Decimal(10, 2)
  laundryCredits   Int // เครดิตสำหรับซักทั่วไป (ชิ้น)
  durationDays     Int // อายุใช้งาน (วัน)
  includesDelivery Boolean @default(false)
  isActive         Boolean @default(true) // เปิดขายหรือไม่

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft Delete

  // --- Relations ---
  userPackages UserPackage[]
  inclusions   PackageInclusion[] // ของแถมในแพ็คเกจ
}

// ตารางเก็บ "ของแถม" ในแพ็คเกจ (เช่น แถมซักผ้านวมฟรี 1 ผืน)
model PackageInclusion {
  id                Int    @id @default(autoincrement())
  packageId         Int
  storefrontPriceId BigInt // อ้างอิง ID ของราคาหน้าร้าน (เช่น ID ของผ้านวม)
  quantityLimit     Int // จำนวนที่แถม

  // --- Relations ---
  package         Package         @relation(fields: [packageId], references: [id], onDelete: Cascade)
  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id])
}

model UserPackage {
  id               BigInt        @id @default(autoincrement())
  userId           String
  packageId        Int
  status           PackageStatus @default(PENDING)
  startDate        DateTime? // เริ่มนับเมื่อ status = ACTIVE
  endDate          DateTime? // หมดอายุเมื่อไร
  remainingCredits Int // เครดิตทั่วไปคงเหลือ

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  user         User               @relation(fields: [userId], references: [id])
  package      Package            @relation(fields: [packageId], references: [id])
  orders       Order[] // ใช้กับออเดอร์ไหนบ้าง
  transactions PaymentTransaction[] // สลิปโอนเงินรายการไหนที่ซื้อแพ็คเกจนี้
  usageHistory UserPackageUsage[] // ประวัติการใช้ของแถม

  @@index([userId, status])
}

// ตารางบันทึกการใช้ "ของแถม" ของลูกค้า (Cross-selling usage)
model UserPackageUsage {
  id                BigInt @id @default(autoincrement())
  userPackageId     BigInt
  storefrontPriceId BigInt
  quantityUsed      Int    @default(0) // ใช้ไปแล้วกี่สิทธิ์
  quantityLimit     Int // สิทธิ์ทั้งหมดที่มี (Copy มาจาก Inclusion)

  // --- Relations ---
  userPackage     UserPackage     @relation(fields: [userPackageId], references: [id])
  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id])
}

// ------------------------------------------
// 4. FINANCIAL (การเงิน) *สำคัญมากที่เพิ่มมา*
// ------------------------------------------

model PaymentTransaction {
  id            BigInt        @id @default(autoincrement())
  userId        String // คนจ่าย
  userPackageId BigInt // จ่ายค่าแพ็คเกจไหน
  amount        Decimal       @db.Decimal(10, 2)
  slipUrl       String // รูปสลิป (Cloudinary)
  status        PaymentStatus @default(PENDING)
  verifiedById  String? // Admin คนไหนเป็นคนกดยืนยัน

  createdAt DateTime @default(now())
  verifiedAt DateTime?

  // --- Relations ---
  user        User        @relation(fields: [userId], references: [id])
  userPackage UserPackage @relation(fields: [userPackageId], references: [id])
}

// ------------------------------------------
// 5. STOREFRONT (หน้าร้าน)
// ------------------------------------------

model StorefrontService {
  id        Int       @id @default(autoincrement())
  name      String    @unique // เช่น ซักอบรีด, ซักแห้ง
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  prices StorefrontPrice[]
}

model StorefrontItem {
  id        Int       @id @default(autoincrement())
  name      String    @unique // เช่น เสื้อเชิ้ต, ผ้านวม
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  prices StorefrontPrice[]
}

model StorefrontPrice {
  id        BigInt  @id @default(autoincrement())
  serviceId Int
  itemId    Int
  price     Decimal @db.Decimal(10, 2) // ราคาปัจจุบัน

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  service StorefrontService @relation(fields: [serviceId], references: [id])
  item    StorefrontItem    @relation(fields: [itemId], references: [id])
  
  // Relations to usage
  orderItems        OrderItem[]
  packageInclusions PackageInclusion[]
  userUsage         UserPackageUsage[]

  @@unique([serviceId, itemId, deletedAt])
}

// ------------------------------------------
// 6. ORDER (ระบบจัดการงาน)
// ------------------------------------------

model Order {
  id                BigInt      @id @default(autoincrement())
  customerId        String
  employeeId        String?
  orderType         OrderType
  currentStatus     OrderStatus @default(PENDING_CHECK)
  
  // ส่วนของ Package Order
  userPackageId     BigInt?
  creditsUsed       Int?        // ใช้ออเดอร์นี้ไปกี่เครดิต (จำนวนชิ้น)

  // ส่วนของ Storefront Order
  totalAmount       Decimal?    @db.Decimal(10, 2)
  
  basketQrId        String?     @unique // QR Code ตะกร้า
  notes             String?
  deliveryAddressId BigInt?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  customer        User                 @relation("CustomerOrders", fields: [customerId], references: [id])
  employee        User?                @relation("EmployeeOrders", fields: [employeeId], references: [id])
  userPackage     UserPackage?         @relation(fields: [userPackageId], references: [id])
  deliveryAddress UserAddress?         @relation(fields: [deliveryAddressId], references: [id])
  
  orderItems      OrderItem[]
  statusHistory   OrderStatusHistory[]
  images          Image[]              // รูปภาพรวมของออเดอร์ (เช่น รูปตะกร้า)

  @@index([deletedAt])
  @@index([customerId, currentStatus])
}

model OrderItem {
  id                BigInt  @id @default(autoincrement())
  orderId           BigInt
  storefrontPriceId BigInt
  quantity          Int
  unitPrice         Decimal @db.Decimal(10, 2) // ราคา ณ วันที่สั่ง (Snapshot)
  totalPrice        Decimal @db.Decimal(10, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id])
  images          Image[]         // รูปเจาะจงรายชิ้น (เช่น เสื้อตัวนี้ขาด)
}

model OrderStatusHistory {
  id         BigInt      @id @default(autoincrement())
  orderId    BigInt
  status     OrderStatus
  employeeId String?     // ใครเป็นคนเปลี่ยนสถานะ
  customerId String?     // หรือลูกค้าเป็นคนเปลี่ยน (เช่น กดยกเลิก/ยืนยัน)
  notes      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // --- Relations ---
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  employee User? @relation("EmployeeHistory", fields: [employeeId], references: [id])
  customer User? @relation("CustomerStatusHistory", fields: [customerId], references: [id])
}

// ------------------------------------------
// 7. ASSETS & ADDRESS (ข้อมูลประกอบ)
// ------------------------------------------

model UserAddress {
  id           BigInt    @id @default(autoincrement())
  userId       String
  addressLine1 String
  city         String?
  postalCode   String?
  isDefault    Boolean   @default(false)
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // --- Relations ---
  user   User    @relation(fields: [userId], references: [id])
  orders Order[]
}

model Image {
  id          Int     @id @default(autoincrement())
  asset_id    String
  public_id   String
  url         String
  secure_url  String
  description String?

  // เชื่อมได้ทั้ง Order (รูปภาพรวม) หรือ OrderItem (รูปภาพรายชิ้น)
  orderId     BigInt? 
  orderItemId BigInt?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // --- Relations ---
  order     Order?     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
}
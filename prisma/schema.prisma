// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  // เปิดใช้ relationJoins เพื่อประสิทธิภาพที่ดีขึ้นในการ query
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//// -------------------------------------- ////
////               ENUMS                    ////
//// -------------------------------------- ////

enum Role {
  User
  EMPLOYEE
  ADMIN
}

enum OrderType {
  PACKAGE
  STOREFRONT
}

enum OrderStatus {
  PENDING_CHECK
  WASHING
  DRYING
  IRONING
  READY_FOR_PICKUP
  COMPLETED
  CANCELLED
}

enum PackageStatus {
  PENDING
  ACTIVE
  EXPIRED
}

enum PaymentStatus {
  PENDING
  VERIFIED
  FAILED
}

// ------------------------------------------
// 2. AUTHENTICATION & USER (Better Auth)
// ------------------------------------------

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified Boolean  @default(false)
  image         String?
  role          Role     @default(User)

  phoneNumber String?
  lineUserId  String?  @unique
  points      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions      Session[]
  accounts      Account[]
  addresses     UserAddress[]
  packages      UserPackage[]
  payments      PaymentTransaction[] @relation("PaymentUser")
  verifiedPays  PaymentTransaction[] @relation("PaymentVerifiedBy")

  customerOrders Order[]            @relation("OrderCustomer")
  employeeOrders Order[]            @relation("OrderEmployee")

  statusAsEmployee OrderStatusHistory[] @relation("StatusEmployee")
  statusAsCustomer OrderStatusHistory[] @relation("StatusCustomer")

  priceChanges StorefrontPriceHistory[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

//// -------------------------------------- ////
////         PACKAGE / SUBSCRIPTION         ////
//// -------------------------------------- ////

model Package {
  id               Int      @id @default(autoincrement())
  name             String
  price            Decimal  @db.Decimal(10, 2)
  laundryCredits   Int
  durationDays     Int
  includesDelivery Boolean  @default(false)
  isActive         Boolean  @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  inclusions   PackageInclusion[]
  userPackages UserPackage[]

  @@index([isActive])
  @@map("packages")
}

model PackageInclusion {
  id                Int    @id @default(autoincrement())
  packageId         Int
  storefrontPriceId BigInt
  quantityLimit     Int

  package          Package         @relation(fields: [packageId], references: [id], onDelete: Restrict)
  storefrontPrice  StorefrontPrice @relation(fields: [storefrontPriceId], references: [id], onDelete: Restrict)

  @@index([packageId])
  @@index([storefrontPriceId])
  @@map("package_inclusions")
}

model UserPackage {
  id               BigInt        @id @default(autoincrement())
  userId           String
  packageId        Int
  status           PackageStatus @default(PENDING)

  startDate        DateTime?
  endDate          DateTime?
  remainingCredits Int?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id], onDelete: Restrict)

  usages        UserPackageUsage[]
  creditLedgers PackageCreditLedger[]
  orders        Order[]
  payment       PaymentTransaction?

  @@index([userId, status, endDate])
  @@map("user_packages")
}

model UserPackageUsage {
  id                BigInt @id @default(autoincrement())
  userPackageId     BigInt
  storefrontPriceId BigInt
  quantityUsed      Int    @default(0)
  quantityLimit     Int

  userPackage     UserPackage     @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id], onDelete: Restrict)

  @@unique([userPackageId, storefrontPriceId])
  @@map("user_package_usages")
}

model PackageCreditLedger {
  id            BigInt   @id @default(autoincrement())
  userPackageId BigInt
  orderId       BigInt?
  delta         Int
  reason        String?
  createdAt     DateTime @default(now())

  userPackage UserPackage @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
  order       Order?      @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userPackageId])
  @@index([orderId])
  @@map("package_credit_ledgers")
}

//// -------------------------------------- ////
////               FINANCIAL                ////
//// -------------------------------------- ////

model PaymentTransaction {
  id            BigInt        @id @default(autoincrement())
  userId        String
  userPackageId BigInt        @unique
  amount        Decimal       @db.Decimal(10, 2)
  slipUrl       String?
  status        PaymentStatus @default(PENDING)
  verifiedById  String?

  verifiedAt DateTime?
  createdAt  DateTime @default(now())

  user        User        @relation("PaymentUser", fields: [userId], references: [id], onDelete: Cascade)
  userPackage UserPackage @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
  verifiedBy  User?       @relation("PaymentVerifiedBy", fields: [verifiedById], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@map("payment_transactions")
}

//// -------------------------------------- ////
////              STOREFRONT                ////
//// -------------------------------------- ////

model StorefrontService {
  id        Int      @id @default(autoincrement())
  name      String
  deletedAt DateTime?

  prices StorefrontPrice[]

  @@unique([name])
  @@map("storefront_services")
}

model StorefrontItem {
  id        Int      @id @default(autoincrement())
  name      String
  deletedAt DateTime?

  prices StorefrontPrice[]

  @@unique([name])
  @@map("storefront_items")
}

model StorefrontPrice {
  id        BigInt   @id @default(autoincrement())
  serviceId Int
  itemId    Int
  price     Decimal  @db.Decimal(10, 2)
  deletedAt DateTime?

  service StorefrontService @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  item    StorefrontItem    @relation(fields: [itemId], references: [id], onDelete: Restrict)

  orderItems OrderItem[]
  inclusions PackageInclusion[]
  usages     UserPackageUsage[]
  history    StorefrontPriceHistory[]

  @@unique([serviceId, itemId])
  @@index([serviceId])
  @@index([itemId])
  @@map("storefront_prices")
}

model StorefrontPriceHistory {
  id                BigInt  @id @default(autoincrement())
  storefrontPriceId BigInt
  oldPrice          Decimal @db.Decimal(10, 2)
  newPrice          Decimal @db.Decimal(10, 2)
  changedAt         DateTime @default(now())
  changedById       String
  note              String?

  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id], onDelete: Cascade)
  changedBy        User            @relation(fields: [changedById], references: [id], onDelete: Restrict)

  @@index([storefrontPriceId])
  @@index([changedAt])
  @@map("storefront_price_histories")
}

//// -------------------------------------- ////
////                BASKET                  ////
//// -------------------------------------- ////

model Basket {
  id        BigInt  @id @default(autoincrement())
  qrCode    String  @unique
  label     String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("baskets")
}

//// -------------------------------------- ////
////                 ORDER                  ////
//// -------------------------------------- ////

model Order {
  id            BigInt     @id @default(autoincrement())
  customerId    String
  employeeId    String?

  orderType     OrderType
  currentStatus OrderStatus @default(PENDING_CHECK)

  // PACKAGE logic
  userPackageId BigInt?
  creditsUsed   Int?

  // STOREFRONT logic
  totalAmount   Decimal?   @db.Decimal(10, 2)

  basketId      BigInt
  notes         String?

  deliveryAddressId       BigInt?
  deliveryAddressSnapshot Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  customer User @relation("OrderCustomer", fields: [customerId], references: [id], onDelete: Restrict)
  employee User? @relation("OrderEmployee", fields: [employeeId], references: [id], onDelete: SetNull)

  userPackage UserPackage? @relation(fields: [userPackageId], references: [id], onDelete: SetNull)
  basket      Basket       @relation(fields: [basketId], references: [id], onDelete: Restrict)

  deliveryAddress UserAddress? @relation(fields: [deliveryAddressId], references: [id], onDelete: SetNull)

  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  images        Image[]
  creditLedgers PackageCreditLedger[]

  @@index([customerId, createdAt])
  @@index([employeeId, currentStatus, createdAt])
  @@index([basketId])
  @@map("orders")
}

model OrderItem {
  id                BigInt  @id @default(autoincrement())
  orderId           BigInt
  storefrontPriceId BigInt

  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  notes     String?

  createdAt DateTime @default(now())

  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  storefrontPrice StorefrontPrice @relation(fields: [storefrontPriceId], references: [id], onDelete: Restrict)
  images          Image[]

  @@index([orderId])
  @@index([storefrontPriceId])
  @@map("order_items")
}

model OrderStatusHistory {
  id         BigInt      @id @default(autoincrement())
  orderId    BigInt
  status     OrderStatus
  employeeId String?
  customerId String?
  notes      String?
  createdAt  DateTime @default(now())

  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  employee User? @relation("StatusEmployee", fields: [employeeId], references: [id], onDelete: SetNull)
  customer User? @relation("StatusCustomer", fields: [customerId], references: [id], onDelete: SetNull)

  @@index([orderId, createdAt])
  @@map("order_status_histories")
}

//// -------------------------------------- ////
////          ADDRESS / DELIVERY            ////
//// -------------------------------------- ////

model UserAddress {
  id           BigInt @id @default(autoincrement())
  userId       String

  addressLine1 String
  addressLine2 String?
  subdistrict  String?
  district     String?
  province     String?
  postalCode   String?

  latitude     Decimal? @db.Decimal(10, 7)
  longitude    Decimal? @db.Decimal(10, 7)

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([userId, isDefault])
  @@map("user_addresses")
}

//// -------------------------------------- ////
////              IMAGES / ASSETS           ////
//// -------------------------------------- ////

model Image {
  id          Int      @id @default(autoincrement())
  url         String
  description String?

  orderId     BigInt?
  orderItemId BigInt?

  createdAt DateTime @default(now())

  order     Order?     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([orderItemId])
  @@map("images")
}